# Canonical Data Contracts

The rebuild relies on durable, queryable artefacts exchanged through the persistence layer. Every service reads and writes through these contracts to avoid hidden coupling. Unless noted, storage lives in the shared SQLite database (with the option to mirror to Parquet for analytics).

## 1. `ticker_universe`
| Column | Type | Description |
| --- | --- | --- |
| `ticker` | TEXT PK | Normalised symbol (e.g., `BRK-B`). |
| `source` | TEXT | Origin of inclusion (e.g., `dynamic_screen`, `manual`). |
| `market` | TEXT | Exchange or index classification. |
| `min_date` | DATE | Earliest date with reliable data. |
| `metadata` | JSON | Additional attributes (sector, liquidity tiers). |
| `updated_at` | TIMESTAMP | Last refresh. |

Produced by **Universe Curator**; consumed by feature/prediction/trading services.

## 2. `market_prices`
| Column | Type | Description |
| --- | --- | --- |
| `ticker` | TEXT | FK -> `ticker_universe`. |
| `date` | DATE | Trading date (UTC). |
| `open`, `high`, `low`, `close` | REAL | OHLC prices. |
| `volume` | REAL | Shares traded. |
| `adjusted_close` | REAL | Adjusted close if available. |
| `source` | TEXT | Data vendor identifier. |
| `ingested_at` | TIMESTAMP | Ingestion time. |
| PRIMARY KEY (`ticker`, `date`). |

Optional `market_intraday` table for high-frequency snapshots with `timestamp` instead of `date`.

## 3. `news_articles`
| Column | Type | Description |
| --- | --- | --- |
| `id` | INTEGER PK |
| `ticker` | TEXT |
| `headline` | TEXT |
| `published_at` | TIMESTAMP |
| `source` | TEXT |
| `url` | TEXT |
| `raw_json` | JSON | Vendor payload (stored for audit). |
| `ingested_at` | TIMESTAMP |

## 4. `news_sentiment`
Aggregated view produced alongside articles.
| Column | Type | Description |
| --- | --- | --- |
| `ticker` | TEXT |
| `as_of` | DATE |
| `article_count` | INTEGER |
| `avg_sentiment` | REAL |
| `buzz_score` | REAL |
| `volatility` | REAL | Sentiment volatility. |
| `method` | TEXT | Scoring approach (`vader`, `openai`). |
| `details` | JSON | Breakdown per method. |
| `created_at` | TIMESTAMP |
| PRIMARY KEY (`ticker`, `as_of`, `method`). |

## 5. `feature_windows`
Stores engineered sequences for model consumption.
| Column | Type | Description |
| --- | --- | --- |
| `id` | TEXT PK | Deterministic hash of (ticker, as_of, feature_version). |
| `ticker` | TEXT |
| `as_of` | DATE | Date the window ends. |
| `sequence_length` | INTEGER |
| `feature_count` | INTEGER |
| `feature_version` | TEXT | Semantic version of feature transformations. |
| `data_path` | TEXT | Path to stored tensor (e.g., `.npy` file) or inline BLOB. |
| `context` | JSON | Additional info (indicators used, sentiment inputs). |
| `created_at` | TIMESTAMP |

## 6. `model_registry`
Tracks models generated by the training orchestrator.
| Column | Type | Description |
| --- | --- | --- |
| `model_id` | TEXT PK | e.g., `lstm_v2_20250115`. |
| `model_type` | TEXT | `lstm`, `ensemble`, etc. |
| `training_data_range` | TEXT | Human-readable date span. |
| `feature_version` | TEXT |
| `metrics` | JSON | Validation metrics (accuracy, precision, recall). |
| `artifact_path` | TEXT | Location of stored weights. |
| `created_at` | TIMESTAMP |
| `promoted_at` | TIMESTAMP | When activated for inference. |

## 7. `predictions`
| Column | Type | Description |
| --- | --- | --- |
| `prediction_id` | TEXT PK | Hash of (ticker, as_of, model_id). |
| `ticker` | TEXT |
| `as_of` | DATE |
| `model_id` | TEXT FK -> `model_registry`. |
| `prediction` | TEXT | `UP`, `DOWN`, `NEUTRAL`. |
| `probability` | REAL |
| `confidence` | REAL |
| `ensemble_score` | REAL | Composite score after blending. |
| `inputs_ref` | TEXT | FK -> `feature_windows.id`. |
| `diagnostics` | JSON | Ensemble breakdown, bounds info, heuristics used. |
| `created_at` | TIMESTAMP |

## 8. `prediction_accuracy`
| Column | Type | Description |
| --- | --- | --- |
| `prediction_id` | TEXT PK |
| `ticker` | TEXT |
| `prediction_date` | DATE |
| `verification_date` | DATE |
| `actual_direction` | TEXT |
| `price_move` | REAL | % change between prediction and verification. |
| `is_correct` | INTEGER | 1/0. |
| `validated_at` | TIMESTAMP |
| `validation_source` | TEXT | `close_vs_close`, `close_vs_intraday`. |

## 9. `feedback_metrics`
| Column | Type | Description |
| --- | --- | --- |
| `id` | INTEGER PK |
| `as_of` | DATE |
| `metric_name` | TEXT | e.g., `quality_score`, `bias_score`. |
| `metric_value` | REAL |
| `status` | TEXT | `OK`, `WARN`, `CRITICAL`. |
| `details` | JSON |
| `created_at` | TIMESTAMP |

`learning_insights` continues to store qualitative notes (reused from existing system).

## 10. `retrain_signals`
| Column | Type | Description |
| --- | --- | --- |
| `id` | INTEGER PK |
| `ticker` | TEXT |
| `reason` | TEXT | e.g., `high_conf_error_cluster`. |
| `confidence` | REAL | Strength of signal. |
| `window_start`, `window_end` | DATE |
| `created_at` | TIMESTAMP |
| `processed_at` | TIMESTAMP | Null until training orchestration handles it. |

## 11. `strategic_priorities`
| Column | Type | Description |
| --- | --- | --- |
| `ticker` | TEXT |
| `as_of` | DATE |
| `tier` | TEXT | `critical`, `high`, etc. |
| `score` | REAL |
| `rationale` | TEXT |
| `factors` | JSON |
| `created_at` | TIMESTAMP |
| PRIMARY KEY (`ticker`, `as_of`). |

## 12. `trade_plans`
| Column | Type | Description |
| --- | --- | --- |
| `plan_id` | TEXT PK |
| `as_of` | DATETIME |
| `ticker` | TEXT |
| `action` | TEXT | `BUY`, `SELL`, `HOLD`. |
| `quantity` | REAL |
| `price_ref` | REAL |
| `prediction_id` | TEXT |
| `confidence` | REAL |
| `reasoning` | JSON |
| `created_at` | TIMESTAMP |

## 13. `executed_trades`
| Column | Type | Description |
| --- | --- | --- |
| `trade_id` | TEXT PK |
| `plan_id` | TEXT FK -> `trade_plans`. |
| `ticker` | TEXT |
| `action` | TEXT |
| `quantity` | REAL |
| `price` | REAL |
| `executed_at` | TIMESTAMP |
| `status` | TEXT | `EXECUTED`, `SKIPPED`, `FAILED`. |
| `notes` | JSON |

## 14. `portfolio_holdings`
Snapshot table for portfolio state.
| Column | Type | Description |
| --- | --- | --- |
| `snapshot_id` | TEXT PK |
| `taken_at` | TIMESTAMP |
| `total_value` | REAL |
| `cash_balance` | REAL |
| `positions` | JSON | Per-ticker holdings with cost basis. |
| `pnl_daily` | REAL |
| `pnl_total` | REAL |
| `win_rate` | REAL |

## 15. `system_health`
| Column | Type | Description |
| --- | --- | --- |
| `component` | TEXT PK |
| `last_success` | TIMESTAMP |
| `last_failure` | TIMESTAMP |
| `status` | TEXT |
| `message` | TEXT |
| `metadata` | JSON |

## 16. `task_runs`
Central log for orchestrator activity.
| Column | Type | Description |
| --- | --- | --- |
| `task_name` | TEXT |
| `run_id` | TEXT PK |
| `triggered_at` | TIMESTAMP |
| `completed_at` | TIMESTAMP |
| `status` | TEXT | `SUCCESS`, `FAILED`, `SKIPPED`. |
| `artifacts` | JSON | Output references, counts. |
| `error` | TEXT |

These schemas serve as the contract for all services. Migration scripts will live under `nextgen_system/migrations/` to create and evolve tables in a controlled manner.
